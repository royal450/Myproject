<!DOCTYPE html>
<html>
<head>
    <title>Email Marketing Tool</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { border: 1px solid #ddd; padding: 20px; margin: 10px 0; border-radius: 10px; }
        button { background: #0070f3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; }
        .stats { display: flex; gap: 10px; margin: 20px 0; }
        .stat-box { flex: 1; background: #f0f0f0; padding: 15px; border-radius: 5px; text-align: center; }
    </style>
</head>
<body>
    <h1>ðŸ“§ Email Marketing Tool</h1>
    
    <div class="stats">
        <div class="stat-box">
            <h3>Today</h3>
            <div id="todayCount">0</div>
        </div>
        <div class="stat-box">
            <h3>Total</h3>
            <div id="totalCount">0</div>
        </div>
        <div class="stat-box">
            <h3>Plan</h3>
            <div id="planType">Free</div>
        </div>
    </div>
    
    <div class="card">
        <h2>Send Email</h2>
        <input type="email" id="toEmail" placeholder="To Email">
        <input type="text" id="subject" placeholder="Subject">
        <textarea id="body" rows="4" placeholder="Message"></textarea>
        <select id="smtpAccount">
            <option value="">Select SMTP Account</option>
        </select>
        <button onclick="sendEmail()">Send Email</button>
        <div id="result"></div>
    </div>
    
    <div class="card">
        <h2>Add SMTP Account</h2>
        <input type="email" id="smtpEmail" placeholder="Your Email">
        <input type="password" id="smtpPassword" placeholder="Password">
        <input type="text" id="smtpServer" value="smtp.gmail.com" placeholder="SMTP Server">
        <input type="number" id="smtpPort" value="587" placeholder="Port">
        <button onclick="addSMTP()">Add SMTP</button>
    </div>
    
    <div class="card">
        <h2>Email History</h2>
        <button onclick="loadHistory()">Refresh History</button>
        <div id="history"></div>
    </div>
    
    <script>
        const API_URL = window.location.origin + '/api';
        
        async function loadStats() {
            try {
                const res = await fetch(API_URL + '/stats');
                const data = await res.json();
                
                if(data.success) {
                    document.getElementById('todayCount').textContent = 
                        `${data.stats.emails_today}/${data.stats.daily_limit}`;
                    document.getElementById('totalCount').textContent = data.stats.total_emails;
                    document.getElementById('planType').textContent = 
                        data.stats.plan === 'paid' ? 'Pro' : 'Free';
                }
            } catch(e) {
                console.error('Error loading stats:', e);
            }
        }
        
        async function loadSMTP() {
            try {
                const res = await fetch(API_URL + '/smtp');
                const data = await res.json();
                
                const select = document.getElementById('smtpAccount');
                select.innerHTML = '<option value="">Select SMTP Account</option>';
                
                if(data.success && data.accounts.length > 0) {
                    data.accounts.forEach(acc => {
                        const option = document.createElement('option');
                        option.value = acc.id;
                        option.textContent = acc.email;
                        select.appendChild(option);
                    });
                }
            } catch(e) {
                console.error('Error loading SMTP:', e);
            }
        }
        
        async function sendEmail() {
            const toEmail = document.getElementById('toEmail').value;
            const subject = document.getElementById('subject').value;
            const body = document.getElementById('body').value;
            const smtpId = document.getElementById('smtpAccount').value;
            
            if(!toEmail || !subject || !body || !smtpId) {
                alert('Please fill all fields');
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        to_email: toEmail,
                        subject: subject,
                        body: body,
                        smtp_account_id: parseInt(smtpId)
                    })
                });
                
                const data = await res.json();
                document.getElementById('result').innerHTML = 
                    `<div style="color: ${data.success ? 'green' : 'red'}">${data.message}</div>`;
                
                if(data.success) {
                    document.getElementById('toEmail').value = '';
                    document.getElementById('subject').value = '';
                    document.getElementById('body').value = '';
                    loadStats();
                }
            } catch(e) {
                document.getElementById('result').innerHTML = 
                    `<div style="color: red">Error: ${e.message}</div>`;
            }
        }
        
        async function addSMTP() {
            const email = document.getElementById('smtpEmail').value;
            const password = document.getElementById('smtpPassword').value;
            const server = document.getElementById('smtpServer').value;
            const port = document.getElementById('smtpPort').value;
            
            if(!email || !password || !server || !port) {
                alert('Please fill all fields');
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/smtp', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        smtp_server: server,
                        smtp_port: parseInt(port)
                    })
                });
                
                const data = await res.json();
                alert(data.message);
                
                if(data.success) {
                    document.getElementById('smtpEmail').value = '';
                    document.getElementById('smtpPassword').value = '';
                    loadSMTP();
                }
            } catch(e) {
                alert('Error: ' + e.message);
            }
        }
        
        async function loadHistory() {
            try {
                const res = await fetch(API_URL + '/history');
                const data = await res.json();
                
                let html = '<table border="1" width="100%">';
                html += '<tr><th>To</th><th>Subject</th><th>Status</th><th>Time</th></tr>';
                
                if(data.success && data.history.length > 0) {
                    data.history.reverse().forEach(email => {
                        html += `<tr>
                            <td>${email.to_email}</td>
                            <td>${email.subject.substring(0, 30)}...</td>
                            <td style="color: ${email.status === 'success' ? 'green' : 'red'}">
                                ${email.status}
                            </td>
                            <td>${email.sent_at}</td>
                        </tr>`;
                    });
                } else {
                    html += '<tr><td colspan="4">No emails sent yet</td></tr>';
                }
                
                html += '</table>';
                document.getElementById('history').innerHTML = html;
            } catch(e) {
                console.error('Error loading history:', e);
            }
        }
        
        // Load on startup
        loadStats();
        loadSMTP();
        loadHistory();
    </script>
</body>
</html>
